<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TRUECAST - Voting Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: bold;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .nav-links {
        display: flex;
        list-style: none;
        gap: 1.5rem;
      }

      .nav-links a {
        color: white;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        transition: all 0.3s ease;
      }

      .nav-links a:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Main Container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 20px;
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      /* Main Content */
      .main-content {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }

      .content-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .content-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .election-status {
        display: inline-block;
        background: #27ae60;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        margin-top: 1rem;
      }
      
      .election-status.inactive {
        background: #e74c3c;
      }

      /* Voting Section */
      .voting-section {
        padding: 2rem;
      }

      .ballot-container {
        margin-bottom: 2rem;
      }

      .ballot-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
      }

      .ballot-title {
        font-size: 1.5rem;
        color: #2c3e50;
      }

      .ballot-info {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .candidates-list {
        display: grid;
        gap: 1rem;
      }

      .candidate-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .candidate-card:hover:not(.voted-on) {
        border-color: #3498db;
        background: #f8fcff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .candidate-card.selected {
        border-color: #27ae60;
        background: #f0fdf4;
      }
      
      .candidate-card.voted-on {
        cursor: not-allowed;
      }

      .candidate-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .candidate-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
      }

      .candidate-details h3 {
        color: #2c3e50;
        margin-bottom: 0.3rem;
      }

      .candidate-party {
        color: #7f8c8d;
        font-size: 0.9rem;
      }
      
      .candidate-region {
        color: #3498db;
        font-size: 0.8rem;
        font-weight: 600;
        margin-top: 5px;
      }

      .selection-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 25px;
        height: 25px;
        border: 2px solid #bdc3c7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .candidate-card.selected .selection-indicator {
        background: #27ae60;
        border-color: #27ae60;
        color: white;
      }

      /* Sidebar */
      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .sidebar-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      }

      .sidebar-card h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      .timer-display {
        text-align: center;
        font-size: 2rem;
        color: #e74c3c;
        font-weight: bold;
        margin: 1rem 0;
      }

      .voting-progress {
        margin-bottom: 1rem;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #3498db 0%, #27ae60 100%);
        transition: width 0.3s ease;
      }

      .security-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #27ae60;
        font-weight: 600;
        margin: 0.5rem 0;
      }

      .blockchain-info {
        font-size: 0.8rem;
        color: #7f8c8d;
        line-height: 1.5;
      }

      /* Vote Summary */
      .vote-summary {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
      }

      .vote-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
      }

      .vote-item:last-child {
        border-bottom: none;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: center;
      }

      .btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }
      
      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-outline {
        background: transparent;
        color: #3498db;
        border: 2px solid #3498db;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Confirmation Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        text-align: center;
      }

      .modal h2 {
        color: #2c3e50;
        margin-bottom: 1rem;
      }

      .final-vote-summary {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
        text-align: left;
      }

      /* Success Animation */
      .vote-success {
        text-align: center;
        padding: 2rem;
      }

      .success-icon {
        font-size: 4rem;
        color: #27ae60;
        margin-bottom: 1rem;
        animation: bounce 1s ease;
      }

      @keyframes bounce {
        0%,
        20%,
        60%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        80% {
          transform: translateY(-5px);
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .sidebar {
          order: -1;
        }

        .candidate-info {
          flex-direction: column;
          text-align: center;
        }

        .action-buttons {
          flex-direction: column;
        }

        .nav-links {
          display: none;
        }
      }
      
      /* Additional Styles for Problem 3 */
      .status-active { background: #d1fae5; color: #059669; }
      .status-ended { background: #fef2f2; color: #b91c1c; }
      .status-published { background: #ccfbf1; color: #0f766e; }

      /* Accessibility */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .high-contrast {
        filter: contrast(150%);
      }

      .large-text {
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">üó≥Ô∏è TRUECAST</div>
        <nav>
          <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/voting-dashboard">Dashboard</a></li>
            <li><a href="/vote-verification">Verify Vote</a></li>
            <li><a href="/results">Results</a></li>
            <li><a href="/help">Help</a></li>
          </ul>
        </nav>
        <div class="user-info">
          <div class="user-avatar">üë§</div>
          <div>
            <div>{{ full_name | default('Guest Voter') }}</div>
            <small>Voter ID: {{ voter_id | default('N/A') }}</small>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="dashboard-grid">
        <div class="main-content">
          <div class="content-header">
            {% if election_active and election %}
              <h1>{{ election.title }}</h1>
              <p>{{ election.description }}</p>
              <span class="election-status">üü¢ ACTIVE</span>
            {% else %}
              <h1>No Active Election</h1>
              <p>Please check back later for the next scheduled election.</p>
              <span class="election-status inactive">üî¥ ENDED</span>
            {% endif %}
          </div>

          <div class="voting-section">
            {% if election_active and filtered_ballot %}
              <div id="ballot">
                {% for race in filtered_ballot %}
                  <div class="ballot-container">
                    <div class="ballot-header">
                      <div>
                        <h2 class="ballot-title">{{ race.name }}</h2>
                        <p class="ballot-info">Select ONE option ‚Ä¢ Required</p>
                      </div>
                    </div>

                    <div class="candidates-list">
                      {% for candidate in race.candidates %}
                        <div
                          class="candidate-card"
                          onclick="selectCandidate('{{ race.name | replace(' ', '-') | lower }}', '{{ candidate.name | replace(' ', '-') | lower }}')"
                          data-race="{{ race.name | replace(' ', '-') | lower }}"
                          data-candidate="{{ candidate.name | replace(' ', '-') | lower }}"
                        >
                          <div class="candidate-info">
                            <div class="candidate-photo">{{ candidate.photoUrl | default('üë§') }}</div>
                            <div class="candidate-details">
                              <h3>{{ candidate.name }}</h3>
                              <p class="candidate-party">{{ candidate.party }}</p>
                              <p class="candidate-region">Region: {{ candidate.region }}</p>
                              <small
                                >{{ candidate.description | default('') }}</small
                              >
                            </div>
                          </div>
                          <div class="selection-indicator"></div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% elif election_active and not filtered_ballot %}
              <div
                style="
                  text-align: center;
                  padding: 5rem 2rem;
                  background: #fff3e0;
                  border: 2px solid #ff9800;
                  border-radius: 10px;
                  margin-top: 2rem;
                "
              >
                <h2 style="color: #ff9800; margin-bottom: 1rem">
                  ‚ö†Ô∏è No races for your region ({{ voter_region | default('N/A') }})
                </h2>
                <p style="font-size: 1.1rem; color: #757575">
                  The current election does not have any races designated for your registered voting region.
                </p>
              </div>
            {% else %}
              <div
                style="
                  text-align: center;
                  padding: 5rem 2rem;
                  background: #f8f8f8;
                  border: 2px solid #ccc;
                  border-radius: 10px;
                  margin-top: 2rem;
                "
              >
                <h2 style="color: #e74c3c; margin-bottom: 1rem">
                  üó≥Ô∏è Election is Not Active
                </h2>
                <p style="font-size: 1.1rem; color: #757575">
                  There is currently no active election available for voting. Please check the results page or contact support for information on the next election.
                </p>
                <p style="margin-top: 1.5rem">
                  <a href="/results" class="btn btn-primary">View Past Results</a>
                </p>
              </div>
            {% endif %}

            {% if has_voted %}
            <div
              style="
                text-align: center;
                padding: 5rem 2rem;
                background: #fff3e0;
                border: 2px solid #ff9800;
                border-radius: 10px;
                margin-top: 2rem;
              "
            >
              <h2 style="color: #ff9800; margin-bottom: 1rem">
                ‚ö†Ô∏è Your vote has already been cast!
              </h2>
              <p style="font-size: 1.1rem; color: #757575">
                Your vote has been securely recorded on the blockchain for this election ({{ election.title if election else '' }}).
              </p>
              <p style="margin-top: 1.5rem">
                <a href="/vote-verification" class="btn btn-primary"
                  >Verify My Vote Details</a
                >
              </p>
            </div>
            {% elif election_active and filtered_ballot %}
            <div class="action-buttons">
              <button class="btn btn-outline" onclick="reviewVote()">
                Review Selections
              </button>
              <button
                class="btn btn-success"
                onclick="submitVote()"
                id="submitVoteBtn"
                disabled
              >
                Cast Vote
              </button>
            </div>
            {% endif %}
          </div>
        </div>

        <div class="sidebar">
          {% if election_active %}
          <div class="sidebar-card">
            <h3>‚è∞ Time Remaining</h3>
            <div class="timer-display" id="electionTimer">00:00:00</div>
            <p style="color: #7f8c8d; text-align: center; font-size: 0.9rem">
              Election ends: <span id="electionEndTime">{{ election.endDate.split('T')[0] }} at {{ election.endDate.split('T')[1].split('.')[0] }} IST</span>
            </p>
          </div>
          {% endif %}

          <div class="sidebar-card">
            <h3>üìä Your Progress</h3>
            <div class="voting-progress">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  margin-bottom: 0.5rem;
                "
              >
                <span>Completed</span>
                <span id="progressText">0/{{ all_race_ids | length }}</span>
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="progressFill"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <div class="vote-summary" id="voteSummary">
              </div>
          </div>

          <div class="sidebar-card">
            <h3>üîí Security Status</h3>
            <div class="security-status">
              <span>üü¢</span>
              <span>Connection Secured</span>
            </div>
            <div class="security-status">
              <span>‚õìÔ∏è</span>
              <span>Blockchain Ready</span>
            </div>
            <div class="security-status">
              <span>üìç</span>
              <span>Location Verified</span>
            </div>
            <div class="blockchain-info">
              Your vote will be encrypted and recorded on an immutable
              blockchain ledger. Hash ID will be generated for verification.
            </div>
          </div>

          <div class="sidebar-card">
            <h3>‚ùì Need Help?</h3>
            <button
              class="btn btn-outline"
              style="width: 100%; margin-bottom: 0.5rem"
              onclick="openHelp()"
            >
              Voting Guide
            </button>
            <button
              class="btn btn-outline"
              style="width: 100%; margin-bottom: 0.5rem"
              onclick="openAccessibility()"
            >
              Accessibility Options
            </button>
            <button
              class="btn btn-outline"
              style="width: 100%"
              onclick="contactSupport()"
            >
              Contact Support
            </button>
          </div>
        </div>
      </div>
      
      {% if all_elections %}
      <div style="margin-top: 3rem; background: white; border-radius: 15px; padding: 2rem; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);">
          <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">All Election History</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
              {% for e in all_elections %}
              <div style="border: 1px solid #e9ecef; border-radius: 10px; padding: 1rem; background: #f8f9fa;">
                  <h4 style="color: #3498db; margin-bottom: 0.5rem;">{{ e.title }}</h4>
                  <p style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 0.5rem;">ID: {{ e.id }}</p>
                  <span class="status-badge 
                      {% if e.status == 'Active' %}status-active
                      {% elif e.published_results %}status-published
                      {% else %}status-ended{% endif %}"
                      style="
                          display: inline-block;
                          padding: 0.3rem 0.8rem;
                          border-radius: 15px;
                          font-size: 0.8rem;
                          font-weight: 600;
                      ">
                      {% if e.published_results %}Results Published{% else %}{{ e.status }}{% endif %}
                  </span>
                  <p style="margin-top: 1rem; font-size: 0.9rem;">
                      **Starts:** {{ e.startDate.split('T')[0] }} **Ends:** {{ e.endDate.split('T')[0] }}
                  </p>
                  {% if e.published_results %}
                    <a href="/results?election_id={{ e.id }}" class="btn btn-primary" style="padding: 0.5rem 1rem; margin-top: 1rem; font-size: 0.8rem;">View Results</a>
                  {% endif %}
              </div>
              {% else %}
              <p>No elections found in the system.</p>
              {% endfor %}
          </div>
      </div>
      {% endif %}
      </div>
    <div class="modal" id="confirmationModal" style="display: none;">
      <div class="modal-content">
        <h2>Confirm Your Vote</h2>
        <p>
          Please review your selections carefully. Once submitted, your vote
          cannot be changed.
        </p>
        <div class="final-vote-summary" id="finalVoteSummary">
          </div>
        <div
          style="
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
          "
        >
          <button class="btn btn-outline" onclick="closeModal('confirmationModal')">
            Review Again
          </button>
          <button class="btn btn-success" onclick="confirmVote()">
            Confirm & Submit Vote
          </button>
        </div>
      </div>
    </div>
    <div class="modal" id="successModal" style="display: none;">
      <div class="modal-content">
        <div class="vote-success">
          <div class="success-icon">‚úÖ</div>
          <h2>Vote Successfully Cast!</h2>
          <p>Your vote has been recorded on the blockchain.</p>
          <div
            style="
              background: #f8f9fa;
              padding: 1rem;
              border-radius: 10px;
              margin: 1rem 0;
            "
          >
            <strong>Transaction Hash:</strong><br />
            <code id="transactionHash" style="word-break: break-all;"></code>
          </div>
          <p style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 2rem">
            Save this hash to verify your vote later. You can view your vote
            verification anytime using this hash.
          </p>
          <button class="btn btn-primary" onclick="goToVerification()">
            Verify My Vote
          </button>
          <button
            class="btn btn-outline"
            onclick="viewResults()"
            style="margin-left: 1rem"
          >
            View Results
          </button>
        </div>
      </div>
    </div> 
    <div class="modal" id="errorModal" style="display: none;">
      <div class="modal-content">
        <div class="vote-success">
          <div class="success-icon" style="color: #e74c3c;">‚ö†Ô∏è</div>
          <h2>Submission Error</h2>
          <p id="errorMessage">An unknown error occurred.</p>
          <button class="btn btn-danger" style="margin-top: 2rem;" onclick="closeModal('errorModal')">
            Close
          </button>
        </div>
      </div>
    </div>
    <script>
    const SERVER_HAS_VOTED = {{ has_voted | tojson | safe }};
    const SERVER_ELECTION_ACTIVE = {{ election_active | tojson | safe }};
    const SERVER_REQUIRED_RACE_NAMES = {{ all_race_ids | tojson | safe }}; 
    const SERVER_ELECTION = {{ election | default({'endDate': '2000-01-01T00:00:00+05:30', 'id': 'NONE'}) | tojson | safe }};
    const filteredBallotJSON = {{ filtered_ballot | tojson | default('[]') | safe }};         
    let votes = {};
    let raceTitles = {}; 
    let candidateDisplayNames = {}; 
    function initializeVoteData() {
        if (!SERVER_ELECTION_ACTIVE) return;            
        try {
            // FIX 1: Robustly parse the JSON data
            const filteredBallot = filteredBallotJSON ? JSON.parse(filteredBallotJSON) : []; 
            
            filteredBallot.forEach(race => {
                const raceSlug = race.name.replace(/ /g, '-').toLowerCase();
                votes[raceSlug] = null; 
                raceTitles[raceSlug] = race.name;                   
                race.candidates.forEach(candidate => {
                    const candidateSlug = candidate.name.replace(/ /g, '-').toLowerCase();
                    candidateDisplayNames[candidateSlug] = candidate.name; 
                });
            });
        } catch (e) {
            console.error("Error parsing filteredBallotJSON:", e);
        }            
        try {
            const previousVotes = {{ previous_votes | default({}) | tojson | safe }};
            Object.keys(previousVotes).forEach(key => {
                if (votes.hasOwnProperty(key)) {
                    votes[key] = previousVotes[key];
                }
            });
        }catch (e) {
            console.error("Could not parse previous votes from server.", e);
        }            
        if (!SERVER_HAS_VOTED) {
            const localStorageKey = `truecast_votes_${SERVER_ELECTION.id}`;
            const savedVotes = localStorage.getItem(localStorageKey);
            if (savedVotes) {
                try {
                    const parsedVotes = JSON.parse(savedVotes);
                    Object.keys(parsedVotes).forEach(raceSlug => {
                        if (votes.hasOwnProperty(raceSlug)) {
                            votes[raceSlug] = parsedVotes[raceSlug];
                        }
                    });
                } catch (e) {
                    console.log('Could not load saved votes from local storage.');
                }
            }
        }
    }
    
    initializeVoteData(); 
    
    function selectCandidate(raceSlug, candidateSlug) {
        if (SERVER_HAS_VOTED) {
            return;
        }           
        const currentRaceCards = document.querySelectorAll(`[data-race="${raceSlug}"]`);
        currentRaceCards.forEach(card => {
            card.classList.remove('selected');
            card.querySelector('.selection-indicator').innerHTML = '';
        });
        const selectedCard = document.querySelector(`[data-race="${raceSlug}"][data-candidate="${candidateSlug}"]`);
        selectedCard.classList.add('selected');
        selectedCard.querySelector('.selection-indicator').innerHTML = '‚úì';
        votes[raceSlug] = candidateSlug;
        updateProgress();
        updateVoteSummary();
    }

    function updateProgress() {
        const requiredRaceSlugs = SERVER_REQUIRED_RACE_NAMES.map(name => name.replace(/ /g, '-').toLowerCase());
        let completed = 0;           
        requiredRaceSlugs.forEach(raceSlug => {
            if (votes.hasOwnProperty(raceSlug) && votes[raceSlug] !== null) {
                completed++;
            }
        });
        const total = requiredRaceSlugs.length;
        const percentage = (completed / total) * 100;
        document.getElementById('progressText').textContent = `${completed}/${total}`;
        document.getElementById('progressFill').style.width = `${percentage}%`;
        if (!SERVER_HAS_VOTED) {
            const submitBtn = document.getElementById('submitVoteBtn');
            if (submitBtn) {
                submitBtn.disabled = completed < total; 
            }
        }
    }

    function updateVoteSummary() {
        const summaryDiv = document.getElementById('voteSummary');
        summaryDiv.innerHTML = '';           
        Object.keys(votes).forEach(raceSlug => {
            const raceTitle = raceTitles[raceSlug];
            const candidateSlug = votes[raceSlug];
            const displayChoice = candidateSlug ? candidateDisplayNames[candidateSlug] : 'Not selected';
            const item = document.createElement('div');
            item.className = 'vote-item';
            item.innerHTML = `
                <span>${raceTitle.length > 20 ? raceTitle.substring(0, 17) + '...' : raceTitle}:</span>
                <span id="${raceSlug}Choice" style="color: ${candidateSlug ? '#2c3e50' : '#e74c3c'}">${displayChoice}</span>
            `;
            summaryDiv.appendChild(item);
        });
    }

    function reviewVote() {
        updateFinalSummary();
        document.getElementById('confirmationModal').style.display = 'flex';
    }

    function submitVote() {
        const totalRequired = SERVER_REQUIRED_RACE_NAMES.length;            
        const completed = Object.values(votes).filter(vote => vote !== null).length;
        if (completed < totalRequired) {
            showErrorModal('Please make selections for all required races before submitting your vote.');
            return;
        }
        reviewVote();
    }

    function updateFinalSummary() {
        const finalSummaryDiv = document.getElementById('finalVoteSummary');
        finalSummaryDiv.innerHTML = '';
        
        // FIX 2: Safer lookup functions with fallbacks
        const getRaceDisplayName = (slug) => raceTitles[slug] || slug.replace(/-/g, ' ').toUpperCase() || "UNDEFINED RACE";
        const getCandidateDisplayName = (slug) => candidateDisplayNames[slug] || slug.replace(/-/g, ' ').toUpperCase() || "UNDEFINED CHOICE";

        Object.keys(votes).forEach(raceSlug => {
            const raceTitle = getRaceDisplayName(raceSlug);
            const candidateSlug = votes[raceSlug];
            
            const displayChoice = candidateSlug ? getCandidateDisplayName(candidateSlug) : 'NOT SELECTED (Error)'; 

            const item = document.createElement('div');
            item.className = 'vote-item';
            item.innerHTML = `
                <strong>${raceTitle}:</strong>
                <span>${displayChoice}</span>
            `;
            finalSummaryDiv.appendChild(item);
        });
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function showErrorModal(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorModal').style.display = 'flex';
    }

    function confirmVote() {
        const confirmBtn = document.querySelector('#confirmationModal .btn-success');
        confirmBtn.textContent = 'Submitting...';
        confirmBtn.disabled = true;
        const voterId = '{{ voter_id | default('N/A') }}';
        fetch('/voting-dashboard', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                voterId: voterId,
                selections: votes
            })
        })
        .then(response => response.json())
        .then(data => {
            closeModal('confirmationModal');
            if (data.success) {
                document.getElementById('transactionHash').textContent = data.transactionHash;
                localStorage.removeItem(`truecast_votes_${SERVER_ELECTION.id}`);
                document.getElementById('successModal').style.display = 'flex';
                setTimeout(() => { window.location.reload(); }, 5000); 
            } else {
                showErrorModal(data.error || "An unknown error occurred during vote submission.");
                confirmBtn.textContent = 'Confirm & Submit Vote';
                confirmBtn.disabled = false;
                if (data.transactionHash === "ALREADY_CAST") {
                    setTimeout(() => { window.location.reload(); }, 3000);
                }
            }
        })
        .catch(error => {
            console.error('Vote submission error:', error);
            closeModal('confirmationModal');
            showErrorModal("Network error: Could not submit vote.");
            confirmBtn.textContent = 'Confirm & Submit Vote';
            confirmBtn.disabled = false;
        });
    }

    function goToVerification() {
        window.location.href = '/vote-verification';
    }

    function viewResults() {
        window.location.href = '/results';
    }

    function openHelp() {
        window.open('/help', '_blank');
    }

    function openAccessibility() {
        document.body.classList.toggle('high-contrast');
        document.body.classList.toggle('large-text');
    }

    function contactSupport() {
        window.open('/help#contact', '_blank');
    }

    function updateTimer() {
        if (!SERVER_ELECTION.endDate) return;
        const electionEnd = new Date(SERVER_ELECTION.endDate).getTime();
        const nowUTC = Date.now();            
        const timeLeft = electionEnd - nowUTC;
        const timerDisplay = document.getElementById("electionTimer");
        if (timeLeft <= 0 || isNaN(timeLeft)) {
            timerDisplay.textContent = "00:00:00";
            clearInterval(timerInterval);                 
            if (SERVER_ELECTION_ACTIVE) {
                setTimeout(() => { window.location.reload(); }, 2000);
            }
            return;
        }
        const h = Math.floor(timeLeft / 3600000);
        const m = Math.floor((timeLeft % 3600000) / 60000);
        const s = Math.floor((timeLeft % 60000) / 1000);
        timerDisplay.textContent =
            `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    let timerInterval;
    function initializeUI() {
        if (SERVER_ELECTION_ACTIVE) {
            initializeBallotInteractions();
            updateVoteSummary(); 
            updateProgress();
            timerInterval = setInterval(updateTimer, 1000); 
            updateTimer(); 
        }
        if (SERVER_HAS_VOTED) {
            document.querySelectorAll('.candidate-card').forEach(card => card.classList.add('voted-on'));
        }
    }
    function initializeBallotInteractions() {
        if (SERVER_HAS_VOTED) {
            document.querySelectorAll('.candidate-card').forEach(card => card.classList.add('voted-on'));
            return;
        }
        Object.keys(votes).forEach(raceSlug => {
            const candidateSlug = votes[raceSlug];
            if (candidateSlug) {
                const selectedCard = document.querySelector(`[data-race="${raceSlug}"][data-candidate="${candidateSlug}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    selectedCard.querySelector('.selection-indicator').innerHTML = '‚úì';
                }
            }
        });
    }
    if (!SERVER_HAS_VOTED && SERVER_ELECTION_ACTIVE) {
        setInterval(() => {
            const localStorageKey = `truecast_votes_${SERVER_ELECTION.id}`;
            localStorage.setItem(localStorageKey, JSON.stringify(votes));
        }, 5000);
    }
    window.addEventListener('load', initializeUI);
    window.addEventListener('beforeunload', function(e) {
        if (!SERVER_HAS_VOTED && SERVER_ELECTION_ACTIVE) {
            const hasVotes = Object.values(votes).some(vote => vote !== null);
            if (hasVotes) {
                e.preventDefault();
                e.returnValue = '';
            }
        }
    });
</script>
  </body>
</html>